// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

////////////////////////////
// AUTH: Supabase Auth handles user/session - auth user id stored in LmsUser.authUserId
////////////////////////////

////////////////////////////
// TENANT / ORGANIZATION
////////////////////////////

model Tenant {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique // For path-based tenant resolution: /t/{slug}/...
  logo        String?
  themeConfig Json? // Nullable JSON for theme customization (Phase-2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations to all tenant-scoped entities
  users               LmsUser[]
  boards              Board[]
  schools             School[]
  classes             Class[]
  sections            Section[]
  subjects            Subject[]
  classSubjects       ClassSubject[]
  courses             Course[]
  modules             Module[]
  lessons             Lesson[]
  enrollments         Enrollment[]
  assessments         Assessment[]
  assessmentQuestions AssessmentQuestion[]
  submissions         Submission[]
  studentAnalytics    StudentAnalytics[]
  rankings            Ranking[]
  subscriptions       Subscription[]
  payments            Payment[]
  studentProfiles     StudentProfile[]
  parentMappings      ParentMapping[]
  progresses          Progress[]
  auditLogs           AuditLog[]
  notices             Notice[]
  notifications       Notification[]
  scheduledClasses    ScheduledClass[]
  classSessions       ClassSession[]
  attendances         Attendance[]
  usageLogs           UsageLog[]
  chapters            Chapter[]
  topics              Topic[]

  @@map("Tenant")
}

////////////////////////////
// USER & ACCESS CONTROL
////////////////////////////

model LmsUser {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  email     String   @unique
  phone     String?
  avatar    String? // Added for user avatar
  createdAt DateTime @default(now())

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Link to Supabase Auth user (auth.users.id)
  authUserId String? @unique

  roles       UserRole[]
  enrollments Enrollment[]
  submissions Submission[]      @relation("StudentSubmissions")
  progresses  Progress[]        @relation("StudentProgress")
  auditLogs   AuditLog[]        @relation("AuditActor")
  analytics   StudentAnalytics?
  rankings    Ranking[]

  // Teacher-owned courses
  teacherCourses            Course[]         @relation("TeacherCourses")
  scheduledClassesAsTeacher ScheduledClass[] @relation("TeacherScheduledClasses")

  // Student-specific profile (only for STUDENT role)
  studentProfile StudentProfile?

  // Parent-student mappings
  parentMappings  ParentMapping[] @relation("ParentMappings")
  studentMappings ParentMapping[] @relation("StudentMappings")
  courses         Course[]

  @@index([tenantId, id])
  @@index([tenantId, email])
  @@map("User")
}

model Role {
  id       String @id @default(uuid()) @db.Uuid
  roleName String

  users     UserRole[]
  auditLogs AuditLog[]
}

model UserRole {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  roleId String @db.Uuid

  lmsUser LmsUser @relation(fields: [userId], references: [id])
  role    Role    @relation(fields: [roleId], references: [id])
}

////////////////////////////
// STUDENT PROFILE (ROLE-BOUND)
////////////////////////////

model StudentProfile {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @unique @db.Uuid
  classId         String   @db.Uuid
  sectionId       String?  @db.Uuid // Optional if sections exist
  tenantId        String   @db.Uuid
  academicHistory Json? // JSON: previous grades, schools, etc.
  engagementScore Float? // Overall engagement metric 0-100
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user   LmsUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  class  Class   @relation(fields: [classId], references: [id])
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([tenantId, classId])
  @@map("StudentProfile")
}

////////////////////////////
// PARENT-STUDENT MAPPING
////////////////////////////

model ParentMapping {
  id            String   @id @default(uuid()) @db.Uuid
  parentUserId  String   @db.Uuid
  studentUserId String   @db.Uuid
  tenantId      String   @db.Uuid
  createdAt     DateTime @default(now())

  // Relations
  parent  LmsUser @relation("ParentMappings", fields: [parentUserId], references: [id], onDelete: Cascade)
  student LmsUser @relation("StudentMappings", fields: [studentUserId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([parentUserId, studentUserId, tenantId])
  @@index([tenantId, parentUserId])
  @@index([tenantId, studentUserId])
  @@map("ParentMapping")
}

////////////////////////////
// ACADEMIC STRUCTURE
////////////////////////////

model Board {
  id   String @id @default(uuid()) @db.Uuid
  name String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  schools School[]

  @@index([tenantId, id])
}

model School {
  id   String @id @default(uuid()) @db.Uuid
  name String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  boardId String @db.Uuid
  board   Board  @relation(fields: [boardId], references: [id])

  classes       Class[]
  subscriptions Subscription[]

  @@index([tenantId, id])
}

model Class {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional Board/School (for backward compatibility)
  schoolId String? @db.Uuid
  school   School? @relation(fields: [schoolId], references: [id])

  // Relations
  sections        Section[]
  studentProfiles StudentProfile[]
  classSubjects   ClassSubject[]
  courses         Course[]

  @@unique([name, tenantId])
  @@index([tenantId, id])
  @@map("Class")
}

model Subject {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  classSubjects ClassSubject[]
  chapters      Chapter[]
  courses       Course[]

  @@unique([name, tenantId])
  @@index([tenantId, id])
  @@map("Subject")
}

////////////////////////////
// SECTION (OPTIONAL)
////////////////////////////

model Section {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  classId   String   @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class  Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([name, classId, tenantId])
  @@index([tenantId, classId])
  @@map("Section")
}

////////////////////////////
// CLASS-SUBJECT MAPPING
////////////////////////////

model ClassSubject {
  id        String   @id @default(uuid()) @db.Uuid
  classId   String   @db.Uuid
  subjectId String   @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())

  // Relations
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId, tenantId])
  @@index([tenantId, classId])
  @@index([tenantId, subjectId])
  @@map("ClassSubject")
}

////////////////////////////
// CONTENT STRUCTURE
////////////////////////////

model Chapter {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  orderIndex Int      @default(0)
  subjectId  String   @db.Uuid
  tenantId   String   @db.Uuid
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  subject Subject @relation(fields: [subjectId], references: [id])
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  topics  Topic[]

  @@index([tenantId, subjectId])
  @@map("Chapter")
}

model Topic {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  orderIndex Int      @default(0)
  chapterId  String   @db.Uuid
  tenantId   String   @db.Uuid
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, chapterId])
  @@map("Topic")
}

////////////////////////////
// LMS CORE - COURSES
////////////////////////////

model Course {
  id          String  @id @default(uuid()) @db.Uuid
  title       String
  description String? @db.Text
  coverImage  String?

  // Teacher ownership (required)
  teacherId String  @db.Uuid
  teacher   LmsUser @relation("TeacherCourses", fields: [teacherId], references: [id])

  // Academic structure (required)
  classId   String  @db.Uuid
  subjectId String  @db.Uuid
  class     Class   @relation(fields: [classId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  modules          Module[]
  lessons          Lesson[]
  enrollments      Enrollment[]
  assessments      Assessment[]
  lmsUser          LmsUser?         @relation(fields: [lmsUserId], references: [id])
  lmsUserId        String?          @db.Uuid
  progresses       Progress[]
  scheduledClasses ScheduledClass[]

  @@index([tenantId, teacherId])
  @@index([tenantId, classId])
  @@index([tenantId, subjectId])
  @@map("Course")
}

////////////////////////////
// MODULES & LESSONS
////////////////////////////

enum ContentType {
  VIDEO
  TEXT
  PDF
}

model Module {
  id         String   @id @default(uuid()) @db.Uuid
  title      String
  orderIndex Int
  courseId   String   @db.Uuid
  tenantId   String   @db.Uuid
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@unique([courseId, orderIndex])
  @@index([tenantId, courseId])
  @@map("Module")
}

model Lesson {
  id          String      @id @default(uuid()) @db.Uuid
  title       String
  contentType ContentType
  content     String      @db.Text
  duration    Int? // In minutes

  // Optional module association
  moduleId String? @db.Uuid
  module   Module? @relation(fields: [moduleId], references: [id], onDelete: SetNull)

  // Required course association
  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  tenantId   String     @db.Uuid
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  progresses Progress[]

  @@index([tenantId, courseId])
  @@index([tenantId, moduleId])
  @@map("Lesson")
}

////////////////////////////
// ENROLLMENT
////////////////////////////

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
}

model Enrollment {
  id       String           @id @default(uuid()) @db.Uuid
  progress Float            @default(0)
  status   EnrollmentStatus @default(ACTIVE)

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String  @db.Uuid
  lmsUser LmsUser @relation(fields: [userId], references: [id])

  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id])

  @@index([tenantId, id])
  @@index([tenantId, userId])
  @@index([tenantId, courseId])
  @@map("Enrollment")
}

////////////////////////////
// ASSESSMENTS
////////////////////////////

enum AssessmentType {
  MCQ
}

enum SubmissionStatus {
  PENDING
  COMPLETED
}

model Assessment {
  id         String         @id @default(uuid()) @db.Uuid
  title      String
  type       AssessmentType @default(MCQ)
  totalMarks Int            @default(100) // SOP: Total marks for the assessment
  dueDate    DateTime?
  courseId   String         @db.Uuid
  tenantId   String         @db.Uuid
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Relations
  course      Course               @relation(fields: [courseId], references: [id])
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  questions   AssessmentQuestion[]
  submissions Submission[]

  @@index([tenantId, courseId])
  @@map("Assessment")
}

model AssessmentQuestion {
  id                 String   @id @default(uuid()) @db.Uuid
  assessmentId       String   @db.Uuid
  questionText       String   @db.Text
  options            Json // Array of strings
  correctOptionIndex Int
  tenantId           String   @db.Uuid
  createdAt          DateTime @default(now())

  // Relations
  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, assessmentId])
  @@map("AssessmentQuestion")
}

// Attempt module: multiple attempts per student per assessment (SOP)
model Submission {
  id            String           @id @default(uuid()) @db.Uuid
  attemptNumber Int              @default(1) // Tracks attempt sequence for historical records
  assessmentId  String           @db.Uuid
  studentId     String           @db.Uuid
  answers       Json // Array of selected indices
  score         Int
  status        SubmissionStatus @default(PENDING)
  submittedAt   DateTime         @default(now())
  tenantId      String           @db.Uuid

  // Relations
  assessment Assessment @relation(fields: [assessmentId], references: [id])
  student    LmsUser    @relation("StudentSubmissions", fields: [studentId], references: [id])
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, assessmentId])
  @@index([tenantId, studentId])
  @@index([assessmentId, studentId, attemptNumber])
  @@map("Submission")
}

////////////////////////////
// PROGRESS TRACKING
////////////////////////////

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model Progress {
  id             String         @id @default(uuid()) @db.Uuid
  studentId      String         @db.Uuid
  lessonId       String         @db.Uuid
  courseId       String         @db.Uuid
  status         ProgressStatus @default(NOT_STARTED)
  lastAccessedAt DateTime       @default(now())
  tenantId       String         @db.Uuid
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  student LmsUser @relation("StudentProgress", fields: [studentId], references: [id])
  lesson  Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId, tenantId])
  @@index([tenantId, studentId])
  @@index([tenantId, courseId])
  @@index([tenantId, lessonId])
  @@map("Progress")
}

////////////////////////////
// ANALYTICS & RANKING
////////////////////////////

model StudentAnalytics {
  id         String @id @default(uuid()) @db.Uuid
  avgScore   Float
  weakTopics String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String  @unique @db.Uuid
  lmsUser LmsUser @relation(fields: [userId], references: [id])

  @@index([tenantId, id])
}

model Ranking {
  id    String @id @default(uuid()) @db.Uuid
  scope String
  rank  Int

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String  @db.Uuid
  lmsUser LmsUser @relation(fields: [userId], references: [id])

  @@index([tenantId, id])
  @@index([tenantId, scope])
  @@map("Ranking")
}

////////////////////////////
// AUDIT LOGGING
////////////////////////////

enum ActionType {
  // Admin actions
  CLASS_CREATED
  CLASS_UPDATED
  SUBJECT_CREATED
  SUBJECT_UPDATED
  SUBJECT_MAPPED
  USER_INVITED

  // Teacher actions
  COURSE_CREATED
  LESSON_CREATED
  ASSESSMENT_CREATED
}

model AuditLog {
  id           String     @id @default(uuid()) @db.Uuid
  actorId      String     @db.Uuid
  actorRole    String // Store role name as string for audit trail
  actionType   ActionType
  resourceType String
  resourceId   String?    @db.Uuid
  metadata     Json?
  tenantId     String     @db.Uuid
  createdAt    DateTime   @default(now())

  // Relations
  actor  LmsUser @relation("AuditActor", fields: [actorId], references: [id])
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role   Role?   @relation(fields: [roleId], references: [id])
  roleId String? @db.Uuid

  @@index([tenantId, createdAt])
  @@index([tenantId, actionType])
  @@map("AuditLog")
}

////////////////////////////
// SUBSCRIPTION & PAYMENTS
////////////////////////////

model Subscription {
  id       String @id @default(uuid()) @db.Uuid
  planName String
  status   String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  payments Payment[]

  @@index([tenantId, id])
}

model Payment {
  id       String   @id @default(uuid()) @db.Uuid
  amount   Float
  status   String
  paidAt   DateTime @default(now())
  tenantId String   @db.Uuid

  subscriptionId String       @db.Uuid
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("Payment")
}

////////////////////////////
// NOTICE MANAGEMENT (SOP ยง10)
////////////////////////////

enum NoticeCategory {
  GENERAL
  URGENT
  ACADEMIC
  ADMINISTRATIVE
}

model Notice {
  id          String         @id @default(uuid()) @db.Uuid
  title       String
  content     String         @db.Text
  category    NoticeCategory @default(GENERAL)
  targetRoles Json // JSON array: ["Student","Teacher"] etc.
  publishedAt DateTime?
  expiresAt   DateTime?
  tenantId    String         @db.Uuid
  createdBy   String         @db.Uuid
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  readReceipts NoticeReadReceipt[]

  @@index([tenantId, publishedAt])
  @@index([tenantId, category])
  @@map("Notice")
}

model NoticeReadReceipt {
  id       String   @id @default(uuid()) @db.Uuid
  noticeId String   @db.Uuid
  userId   String   @db.Uuid
  readAt   DateTime @default(now())
  tenantId String   @db.Uuid

  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  @@unique([noticeId, userId])
  @@index([tenantId])
  @@map("NoticeReadReceipt")
}

////////////////////////////
// NOTIFICATION SYSTEM (SOP ยง9)
////////////////////////////

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  title     String
  body      String   @db.Text
  type      String   @default("system") // system, course, assessment, etc.
  read      Boolean  @default(false)
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([tenantId, read])
  @@map("Notification")
}

////////////////////////////
// CLASS SCHEDULING (SOP ยง7)
////////////////////////////

enum ScheduledClassStatus {
  SCHEDULED
  RUNNING
  COMPLETED
  CANCELLED
}

model ScheduledClass {
  id          String               @id @default(uuid()) @db.Uuid
  courseId    String               @db.Uuid
  teacherId   String               @db.Uuid
  scheduledAt DateTime
  status      ScheduledClassStatus @default(SCHEDULED)
  tenantId    String               @db.Uuid
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  course   Course         @relation(fields: [courseId], references: [id])
  teacher  LmsUser        @relation("TeacherScheduledClasses", fields: [teacherId], references: [id])
  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions ClassSession[]

  @@index([tenantId, scheduledAt])
  @@index([tenantId, status])
  @@map("ScheduledClass")
}

model ClassSession {
  id               String    @id @default(uuid()) @db.Uuid
  scheduledClassId String    @db.Uuid
  startedAt        DateTime  @default(now())
  endedAt          DateTime?
  tenantId         String    @db.Uuid

  scheduledClass ScheduledClass @relation(fields: [scheduledClassId], references: [id], onDelete: Cascade)
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attendances    Attendance[]

  @@index([tenantId])
  @@map("ClassSession")
}

model Attendance {
  id             String   @id @default(uuid()) @db.Uuid
  classSessionId String   @db.Uuid
  userId         String   @db.Uuid
  present        Boolean  @default(true)
  tenantId       String   @db.Uuid
  markedAt       DateTime @default(now())

  classSession ClassSession @relation(fields: [classSessionId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([classSessionId, userId])
  @@index([tenantId])
  @@map("Attendance")
}

////////////////////////////
// USAGE LOGS (SOP ยง8 - Student Profile)
////////////////////////////

enum UsageLogType {
  LOGIN
  CONTENT_ACCESS
  ASSESSMENT_ATTEMPT
  TIME_SPENT
}

model UsageLog {
  id         String       @id @default(uuid()) @db.Uuid
  userId     String       @db.Uuid
  type       UsageLogType
  resourceId String?      @db.Uuid // course, lesson, assessment
  metadata   Json? // e.g. { durationMinutes: 15 }
  tenantId   String       @db.Uuid
  createdAt  DateTime     @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt])
  @@map("UsageLog")
}
