generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"

}

// --------------------------------------------------------
// BETTER AUTH (Standard Tables)
// --------------------------------------------------------

model user {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  image         String?
  role          String?   @default("student")
  
  sessions      session[]
  accounts      account[]
  
  // Link to Domain User
  domainUser    DomainUser?     @relation("AuthLink")
}

model session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  user @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// --------------------------------------------------------
// TENANCY & DOMAINS
// --------------------------------------------------------

model Tenant {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique
  logo        String?
  themeConfig Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       DomainUser[]
  classes     Class[]
  sections    Section[]
  subjects    Subject[]
  course      Course[]
  modules     Module[]
  lessons     Lesson[]
  assessments Assessment[]
  questions   Question[]
  submissions Submission[]
  progress    Progress[]
  auditLogs   AuditLog[]
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

model DomainUser {
  @@map("User")
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  email        String
  
  role         UserRole
  
  tenantId     String   @db.Uuid
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  
  // Link to Better Auth
  authUserId   String?  @unique
  authUser     user?    @relation("AuthLink", fields: [authUserId], references: [id])
  
  avatar       String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([email, tenantId]) // Enforce email uniqueness per tenant

  studentProfile StudentProfile?
  
  // Parent Relations
  parents        ParentMapping[] @relation("Student")
  children       ParentMapping[] @relation("Parent")

  // Teacher Relations
  createdCourses Course[] 

  
  // Student Relations
  submissions    Submission[]
  progress       Progress[]
  
  auditLogs      AuditLog[]
}

model StudentProfile {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @db.Uuid
  user      DomainUser     @relation(fields: [userId], references: [id])
  
  sectionId String?  @db.Uuid
  section   Section? @relation(fields: [sectionId], references: [id])
  
  classId   String?  @db.Uuid // Added as per Phase-1 Req
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ParentMapping {
  id        String @id @default(uuid()) @db.Uuid
  
  createdAt DateTime @default(now())
  
  parentId  String @db.Uuid
  parent    DomainUser   @relation("Parent", fields: [parentId], references: [id])
  
  studentId String @db.Uuid
  student   DomainUser   @relation("Student", fields: [studentId], references: [id])
}

// --------------------------------------------------------
// ACADEMIC STRUCTURE
// --------------------------------------------------------


model Class {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(true)
  
  tenantId    String   @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  // Teacher relation removed for strict Phase-1 compliance (no teacher assignment to class yet)
  // teacherId String? @db.Uuid
  // teacher   User?   @relation("ClassTeacher", fields: [teacherId], references: [id])
  
  sections    Section[]
  subjects    ClassSubject[]
  courses     Course[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Section {
  id       String   @id @default(uuid()) @db.Uuid
  name     String
  isActive Boolean  @default(true)
  
  classId  String   @db.Uuid
  class    Class    @relation(fields: [classId], references: [id])
  
  tenantId String   @db.Uuid
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  
  students StudentProfile[]
  
  createdAt DateTime @default(now())
  // No updatedAt required by prompt, but typically good practice. Prompt didn't strictly forbid it, but listed only createdAt.
}

model Subject {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(true)
  
  tenantId    String   @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  classes     ClassSubject[]
  courses     Course[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ClassSubject {
  id        String   @id @default(uuid()) @db.Uuid
  
  classId   String   @db.Uuid
  class     Class    @relation(fields: [classId], references: [id])
  
  subjectId String   @db.Uuid
  subject   Subject  @relation(fields: [subjectId], references: [id])
  
  tenantId  String   @db.Uuid
  // No direct relation to Tenant needed if inferred, but adding for strict compliance (and prompt asked for it)
  
  createdAt DateTime @default(now())
}

// --------------------------------------------------------
// LMS CORE
// --------------------------------------------------------

model Course {
  id          String   @id @default(uuid()) @db.Uuid
  title       String
  description String?
  thumbnail   String?
  
  subjectId   String   @db.Uuid
  subject     Subject  @relation(fields: [subjectId], references: [id])
  
  createdById String   @db.Uuid
  createdBy   DomainUser     @relation(fields: [createdById], references: [id])
  
  tenantId    String   @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  classId     String   @db.Uuid
  class       Class    @relation(fields: [classId], references: [id])

  modules     Module[]
  assessments Assessment[]
}

model Module {
  id       String @id @default(uuid()) @db.Uuid
  title    String
  order    Int    @default(0)
  
  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id])
  
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  
  lessons  Lesson[]
}

model Lesson {
  id       String @id @default(uuid()) @db.Uuid
  title    String
  content  String? // Markdown or HTML
  type     String  @default("TEXT") // "VIDEO", "TEXT"
  url      String?
  order    Int     @default(0)
  
  moduleId String @db.Uuid
  module   Module @relation(fields: [moduleId], references: [id])
  
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  
  progress Progress[]
}

// --------------------------------------------------------
// ASSESSMENTS
// --------------------------------------------------------

model Assessment {
  id         String @id @default(uuid()) @db.Uuid
  title      String
  type       String // "MCQ" | "Assignment"
  dueDate    DateTime?
  totalMarks Int?
  
  courseId   String @db.Uuid
  course     Course @relation(fields: [courseId], references: [id])
  
  tenantId   String @db.Uuid
  tenant     Tenant @relation(fields: [tenantId], references: [id])
  
  questions  Question[]
  submissions Submission[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Question {
  id            String @id @default(uuid()) @db.Uuid
  text          String
  options       Json
  correctOption Int
  marks         Int    @default(1)
  
  assessmentId  String @db.Uuid
  assessment    Assessment @relation(fields: [assessmentId], references: [id])
  
  tenantId      String @db.Uuid
  tenant        Tenant @relation(fields: [tenantId], references: [id])
}

model Submission {
  id           String   @id @default(uuid()) @db.Uuid
  score        Int?
  answers      Json?
  status       String   @default("Pending") // "Pending" | "Completed"
  
  submittedAt  DateTime?
  createdAt    DateTime @default(now())
  
  assessmentId String   @db.Uuid
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  
  studentId    String   @db.Uuid
  student      DomainUser     @relation(fields: [studentId], references: [id])
  
  tenantId     String   @db.Uuid
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([studentId, assessmentId])
}

enum ProgressStatus {
  Completed
  InProgress
}

model Progress {
  id           String         @id @default(uuid()) @db.Uuid
  
  tenantId     String         @db.Uuid
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  
  studentId    String         @db.Uuid
  student      DomainUser     @relation(fields: [studentId], references: [id])
  
  lessonId     String         @db.Uuid
  lesson       Lesson         @relation(fields: [lessonId], references: [id])
  
  status       ProgressStatus @default(InProgress)
  lastAccessed DateTime?
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  @@unique([studentId, lessonId])
}

// --------------------------------------------------------
// GOVERNANCE
// --------------------------------------------------------

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  action    String
  details   Json?
  createdAt DateTime @default(now())
  
  userId    String   @db.Uuid
  user      DomainUser     @relation(fields: [userId], references: [id])
  
  tenantId  String   @db.Uuid
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}
