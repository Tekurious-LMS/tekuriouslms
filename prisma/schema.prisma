// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

////////////////////////////
// BETTER AUTH TABLES
////////////////////////////

model user {
  id            String   @id @default(cuid())
  email         String   @unique
  emailVerified Boolean  @default(false)
  name          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  image         String?
  role          String?  @default("Student") // Custom field for role-based auth

  sessions session[]
  accounts account[]

  // Link to LMS User model
  lmsUser LmsUser? @relation("BetterAuthUser")
}

model session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

////////////////////////////
// TENANT / ORGANIZATION
////////////////////////////

model Tenant {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique // For path-based tenant resolution: /t/{slug}/...
  logo        String?
  themeConfig Json? // Nullable JSON for theme customization (Phase-2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations to all tenant-scoped entities
  users            LmsUser[]
  boards           Board[]
  schools          School[]
  classes          Class[]
  sections         Section[]
  subjects         Subject[]
  classSubjects    ClassSubject[]
  courses          Course[]
  modules          Module[]
  lessons          Lesson[]
  enrollments      Enrollment[]
  assessments      Assessment[]
  attempts         Attempt[]
  studentAnalytics StudentAnalytics[]
  rankings         Ranking[]
  subscriptions    Subscription[]
  studentProfiles  StudentProfile[]
  parentMappings   ParentMapping[]

  @@map("Tenant")
}

////////////////////////////
// USER & ACCESS CONTROL
////////////////////////////

model LmsUser {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  email     String   @unique
  phone     String?
  avatar    String? // Added for user avatar
  createdAt DateTime @default(now())

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Link to Better Auth user
  betterAuthUserId String? @unique
  betterAuthUser   user?   @relation("BetterAuthUser", fields: [betterAuthUserId], references: [id])

  roles       UserRole[]
  enrollments Enrollment[]
  attempts    Attempt[]
  analytics   StudentAnalytics?
  rankings    Ranking[]

  // Teacher-owned courses
  teacherCourses Course[] @relation("TeacherCourses")

  // Student-specific profile (only for STUDENT role)
  studentProfile StudentProfile?

  // Parent-student mappings
  parentMappings  ParentMapping[] @relation("ParentMappings")
  studentMappings ParentMapping[] @relation("StudentMappings")
  courses         Course[]

  @@index([tenantId, id])
  @@index([tenantId, email])
  @@map("User")
}

model Role {
  id       String @id @default(uuid()) @db.Uuid
  roleName String

  users UserRole[]
}

model UserRole {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  roleId String @db.Uuid

  lmsUser LmsUser @relation(fields: [userId], references: [id])
  role    Role    @relation(fields: [roleId], references: [id])
}

////////////////////////////
// STUDENT PROFILE (ROLE-BOUND)
////////////////////////////

model StudentProfile {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @db.Uuid
  classId   String   @db.Uuid
  sectionId String?  @db.Uuid // Optional if sections exist
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   LmsUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  class  Class   @relation(fields: [classId], references: [id])
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([tenantId, classId])
  @@map("StudentProfile")
}

////////////////////////////
// PARENT-STUDENT MAPPING
////////////////////////////

model ParentMapping {
  id            String   @id @default(uuid()) @db.Uuid
  parentUserId  String   @db.Uuid
  studentUserId String   @db.Uuid
  tenantId      String   @db.Uuid
  createdAt     DateTime @default(now())

  // Relations
  parent  LmsUser @relation("ParentMappings", fields: [parentUserId], references: [id], onDelete: Cascade)
  student LmsUser @relation("StudentMappings", fields: [studentUserId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([parentUserId, studentUserId, tenantId])
  @@index([tenantId, parentUserId])
  @@index([tenantId, studentUserId])
  @@map("ParentMapping")
}

////////////////////////////
// ACADEMIC STRUCTURE
////////////////////////////

model Board {
  id   String @id @default(uuid()) @db.Uuid
  name String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  schools School[]

  @@index([tenantId, id])
}

model School {
  id   String @id @default(uuid()) @db.Uuid
  name String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  boardId String @db.Uuid
  board   Board  @relation(fields: [boardId], references: [id])

  classes       Class[]
  subscriptions Subscription[]

  @@index([tenantId, id])
}

model Class {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional Board/School (for backward compatibility)
  schoolId String? @db.Uuid
  school   School? @relation(fields: [schoolId], references: [id])

  // Relations
  sections        Section[]
  studentProfiles StudentProfile[]
  classSubjects   ClassSubject[]
  courses         Course[]

  @@unique([name, tenantId])
  @@index([tenantId, id])
  @@map("Class")
}

model Subject {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  classSubjects ClassSubject[]
  chapters      Chapter[]
  courses       Course[]

  @@unique([name, tenantId])
  @@index([tenantId, id])
  @@map("Subject")
}

////////////////////////////
// SECTION (OPTIONAL)
////////////////////////////

model Section {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  classId   String   @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class  Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([name, classId, tenantId])
  @@index([tenantId, classId])
  @@map("Section")
}

////////////////////////////
// CLASS-SUBJECT MAPPING
////////////////////////////

model ClassSubject {
  id        String   @id @default(uuid()) @db.Uuid
  classId   String   @db.Uuid
  subjectId String   @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())

  // Relations
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId, tenantId])
  @@index([tenantId, classId])
  @@index([tenantId, subjectId])
  @@map("ClassSubject")
}

////////////////////////////
// CONTENT STRUCTURE
////////////////////////////

model Chapter {
  id   String @id @default(uuid()) @db.Uuid
  name String

  subjectId String  @db.Uuid
  subject   Subject @relation(fields: [subjectId], references: [id])

  topics Topic[]
}

model Topic {
  id   String @id @default(uuid()) @db.Uuid
  name String

  chapterId String  @db.Uuid
  chapter   Chapter @relation(fields: [chapterId], references: [id])
}

////////////////////////////
// LMS CORE - COURSES
////////////////////////////

model Course {
  id          String  @id @default(uuid()) @db.Uuid
  title       String
  description String? @db.Text
  coverImage  String?

  // Teacher ownership (required)
  teacherId String  @db.Uuid
  teacher   LmsUser @relation("TeacherCourses", fields: [teacherId], references: [id])

  // Academic structure (required)
  classId   String  @db.Uuid
  subjectId String  @db.Uuid
  class     Class   @relation(fields: [classId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  modules     Module[]
  lessons     Lesson[]
  enrollments Enrollment[]
  assessments Assessment[]
  lmsUser     LmsUser?     @relation(fields: [lmsUserId], references: [id])
  lmsUserId   String?      @db.Uuid

  @@index([tenantId, teacherId])
  @@index([tenantId, classId])
  @@index([tenantId, subjectId])
  @@map("Course")
}

////////////////////////////
// MODULES & LESSONS
////////////////////////////

enum ContentType {
  VIDEO
  TEXT
  PDF
}

model Module {
  id         String   @id @default(uuid()) @db.Uuid
  title      String
  orderIndex Int
  courseId   String   @db.Uuid
  tenantId   String   @db.Uuid
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@unique([courseId, orderIndex])
  @@index([tenantId, courseId])
  @@map("Module")
}

model Lesson {
  id          String      @id @default(uuid()) @db.Uuid
  title       String
  contentType ContentType
  content     String      @db.Text
  duration    Int? // In minutes

  // Optional module association
  moduleId String? @db.Uuid
  module   Module? @relation(fields: [moduleId], references: [id], onDelete: SetNull)

  // Required course association
  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  tenantId  String   @db.Uuid
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, courseId])
  @@index([tenantId, moduleId])
  @@map("Lesson")
}

////////////////////////////
// ENROLLMENT
////////////////////////////

model Enrollment {
  id       String @id @default(uuid()) @db.Uuid
  progress Float
  status   String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String  @db.Uuid
  lmsUser LmsUser @relation(fields: [userId], references: [id])

  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id])

  @@index([tenantId, id])
  @@index([tenantId, userId])
}

////////////////////////////
// ASSESSMENTS
////////////////////////////

model Assessment {
  id         String @id @default(uuid()) @db.Uuid
  title      String
  totalMarks Int

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id])

  attempts Attempt[]

  @@index([tenantId, id])
}

model Attempt {
  id    String @id @default(uuid()) @db.Uuid
  score Int

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  assessmentId String     @db.Uuid
  assessment   Assessment @relation(fields: [assessmentId], references: [id])

  userId  String  @db.Uuid
  lmsUser LmsUser @relation(fields: [userId], references: [id])

  @@index([tenantId, id])
  @@index([tenantId, userId])
}

////////////////////////////
// ANALYTICS & RANKING
////////////////////////////

model StudentAnalytics {
  id         String @id @default(uuid()) @db.Uuid
  avgScore   Float
  weakTopics String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String  @unique @db.Uuid
  lmsUser LmsUser @relation(fields: [userId], references: [id])

  @@index([tenantId, id])
}

model Ranking {
  id    String @id @default(uuid()) @db.Uuid
  scope String
  rank  Int

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String  @db.Uuid
  lmsUser LmsUser @relation(fields: [userId], references: [id])

  @@index([tenantId, id])
  @@index([tenantId, scope])
}

////////////////////////////
// SUBSCRIPTION & PAYMENTS
////////////////////////////

model Subscription {
  id       String @id @default(uuid()) @db.Uuid
  planName String
  status   String

  // Multi-tenancy
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  payments Payment[]

  @@index([tenantId, id])
}

model Payment {
  id     String @id @default(uuid()) @db.Uuid
  amount Float
  status String

  subscriptionId String       @db.Uuid
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
}
